<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Forgot Password Page</title>
        <link rel="stylesheet" href="../Auth/ForgotPassword.css">
        <link rel="stylesheet" href="../../components/Sidebar.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    </head>
    <body>
        <main class="admin-container">
            <div class="admin">
                <div class="brand-logo">
                    <img src="../../assets/OBH-FULL-LOGO.png" alt="OBH Full Logo">
                </div>
                
                <div class="login-container">
                    <div class="login-form">
                        <div class="admin-icon">
                            <i class="fa-solid fa-key"></i> 
                            <h2 class="login">Forgot Password?</h2>
                            <p class="instructions">Enter your email and we'll send you a reset code.</p>
                        </div>
                        
                        <div class="form-group-container">
                            <form id="forgotForm">
                                <div class="form-group">
                                    
                                        <input type="email" id="email" name="email" placeholder="Email" required autocomplete="email" class="input-field">
                                    
                                    <svg width="22" height="22" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M16.398 0.044342C13.0825 0.363766 9.97845 1.53812 7.35805 3.46876C1.5913 7.71522 -1.12772 14.968 0.43607 21.939C1.19213 25.2882 2.91089 28.3791 5.36693 30.803C6.38597 31.8082 7.29701 32.5316 8.45224 33.2551C14.3834 36.966 21.9017 36.9096 27.7953 33.1141C30.1151 31.6157 32.1297 29.5112 33.5292 27.1249C34.7501 25.044 35.5203 22.7986 35.8678 20.309C35.9899 19.4118 36.0416 17.4952 35.9617 16.5604C35.572 11.8771 33.4024 7.55081 29.8991 4.46931C27.1284 2.03135 23.8365 0.570454 20.0374 0.0913162C19.2626 -0.00732803 17.2104 -0.0308151 16.398 0.044342ZM19.2719 1.34083C22.3713 1.59449 25.2312 2.62792 27.7014 4.39884C31.7071 7.27366 34.2054 11.6563 34.6468 16.598C34.7267 17.5187 34.6797 19.3554 34.5529 20.2479C34.0927 23.3999 32.8482 26.2418 30.8759 28.6234C26.9547 33.3631 20.7606 35.5615 14.7309 34.3589C9.71078 33.3584 5.42798 30.1031 3.12691 25.5372C1.47859 22.2772 0.943244 18.6273 1.58191 15.0338C2.72305 8.64531 7.50363 3.48285 13.8057 1.83406C14.5947 1.62737 15.5386 1.45826 16.2571 1.3925C16.567 1.36432 16.8864 1.33143 16.9615 1.32204C17.2949 1.28446 18.7178 1.29855 19.2719 1.34083Z" fill="#333446"/>
                                        <path d="M17.0319 3.29495C16.9662 3.30435 16.7126 3.34662 16.4684 3.3889C12.4204 4.06533 9.42432 7.61187 9.42432 11.7268C9.42432 14.0708 10.3447 16.2457 12.0165 17.8569C13.4723 19.2615 15.2521 20.0506 17.3325 20.2291C17.9336 20.2761 18.2905 20.262 19.1217 20.1493C21.7984 19.7829 24.1605 18.1106 25.4191 15.6914C27.1191 12.4314 26.5696 8.53257 24.029 5.87853C22.8269 4.62432 21.2959 3.77879 19.5772 3.42648C19.0747 3.32314 18.8352 3.29965 18.0651 3.28556C17.5626 3.28086 17.0977 3.28556 17.0319 3.29495Z" fill="#333446"/>
                                        <path d="M26.3253 17.4858C26.2408 17.6079 25.9919 17.9179 25.7665 18.1763C24.2403 19.9566 22.1646 21.2202 20.0796 21.643C19.6006 21.7416 19.4174 21.751 18.3467 21.751C17.0976 21.7463 16.4965 21.6899 15.2004 21.441C14.0686 21.2202 12.4907 20.572 11.5374 19.9284C10.3353 19.1205 9.61676 18.4111 9.25517 17.6737C9.18003 17.528 9.1002 17.4059 9.07202 17.4059C9.04384 17.4059 8.79965 17.5515 8.53197 17.73C6.87896 18.8198 5.73782 20.1304 5.10855 21.6571C4.58259 22.9441 4.53563 24.4943 4.98645 25.8378C6.09472 29.1212 10.0347 31.7236 14.989 32.4329C16.1208 32.5973 16.952 32.6396 18.3608 32.6114C20.7464 32.5645 22.6248 32.2121 24.6488 31.4277C28.2319 30.0325 30.594 27.5899 31.0496 24.8043C31.3595 22.9301 30.6598 20.9337 29.1289 19.3037C28.4808 18.6131 27.3162 17.6971 26.6165 17.3401L26.4756 17.265L26.3253 17.4858Z" fill="#333446"/>
                                    </svg>
                                </div>
                                <button type="submit" class="submit-btn">Continue</button>
                            </form>
                        </div>
                    </div>

                    <div class="create-account">
                        <p>Go back to <a href="../Auth/LoginPage.html">Login</a></p>
                    </div>
                </div>
            </div>
        </main>
        <script>
                document.addEventListener('DOMContentLoaded', function() {
                console.log("üîë ForgotPassword page loaded");
                
                setTimeout(() => {
                    let supabaseClient;
                    const supabaseUrl = 'https://vxukqznjkdtuytnkhldu.supabase.co';
                    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4dWtxem5qa2R0dXl0bmtobGR1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTI0NDE4MCwiZXhwIjoyMDc2ODIwMTgwfQ.7hCf7BDqlVuNkzP1CcbORilAzMqOHhexP4Y7bsTPRJA';
                    
                    if (typeof supabase !== 'undefined' && supabase.createClient) {
                        console.log("‚úÖ Using global Supabase from CDN");
                        supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                    } else {
                        console.error("‚ùå Supabase library not available");
                        alert('Application failed to load. Please refresh the page.');
                        return;
                    }

                    console.log("‚úÖ Supabase client created:", !!supabaseClient);

                    document.getElementById("forgotForm").addEventListener("submit", async (e) => {
                        e.preventDefault();
                        
                        const email = document.getElementById("email").value.trim();
                        const submitButton = document.querySelector('button[type="submit"]');
                        
                        if (!email || !email.includes('@')) {
                            alert("Please enter a valid email address.");
                            return;
                        }

                        submitButton.disabled = true;
                        const originalText = submitButton.textContent;
                        submitButton.textContent = "Sending...";

                        try {
                            console.log("üìß Sending reset email to:", email);

                            // USE YOUR ACTUAL REDIRECT URL
                            const redirectTo = "https://password-reset-app-sigma.vercel.app/ResetPassword.html";
                            
                            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                                redirectTo: redirectTo
                            });

                            if (error) throw error;

                            alert("‚úÖ Password reset email sent!\n\nCheck your email for the reset link.");
                            window.location.href = "LoginPage.html";

                        } catch (error) {
                            console.error("‚ùå Reset password error:", error);
                            
                            if (error.message.includes('Email not confirmed')) {
                                alert("‚ùå Please confirm your email address before resetting your password.");
                            } else if (error.message.includes('User not found')) {
                                alert("‚ùå No account found with that email address.");
                            } else if (error.message.includes('rate limit')) {
                                alert("‚ùå Too many attempts. Please try again in a few minutes.");
                            } else {
                                alert("‚ùå Failed to send reset email: " + error.message);
                            }
                        } finally {
                            submitButton.disabled = false;
                            submitButton.textContent = originalText;
                        }
                    });
                }, 100);
            });
        </script>
    </body>
</html>